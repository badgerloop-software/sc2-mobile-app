name: SC2 Mobile App - CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  ci:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: ğŸ— Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ— Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install dependencies
      run: npm ci
    
    - name: ğŸ” Check for security vulnerabilities
      run: npm audit --audit-level=high
      continue-on-error: true
    
    - name: ğŸ’… Lint code
      run: |
        # Run linting (will skip if no .eslintrc config exists)
        npx eslint src/ --ext .js,.jsx,.ts,.tsx --max-warnings 0 || echo "ESLint not configured, skipping..."
    
    - name: âŒ¨ï¸ Type checking (if TypeScript)
      run: |
        if [ -f "tsconfig.json" ]; then
          npx tsc --noEmit
        else
          echo "No TypeScript configuration found, skipping type checking"
        fi
    
    - name: âš™ï¸ Validate Expo configuration
      run: npx expo config --type public
    
    - name: ğŸ©º Run Expo Doctor
      run: npx expo-doctor
      
    - name: âœ… Check for Expo SDK compatibility
      run: npx expo install --check
      continue-on-error: true
      
    - name: ğŸ§ª Test bundle creation and check size
      run: |
        npx expo export --platform all --dev --output-dir ./test-build
        echo "âœ… Metro bundling successful"
        echo "Bundle size:"
        du -sh ./test-build
        size_kb=$(du -s ./test-build | cut -f1)
        echo "Bundle size: ${size_kb}KB"
        if [ $size_kb -gt 51200 ]; then
          echo "âš ï¸  Warning: Bundle size is large (${size_kb}KB > 50MB)"
        else
          echo "âœ… Bundle size is acceptable"
        fi

    - name: ğŸ“‚ Validate file structure
      run: |
        echo "Checking essential files..."
        test -f package.json && echo "âœ… package.json exists"
        test -f app.json && echo "âœ… app.json exists"
        test -f App.js && echo "âœ… App.js exists"
        test -f src/screens/HomeScreen.js && echo "âœ… HomeScreen.js exists"
        test -f src/screens/BatteryScreen.js && echo "âœ… BatteryScreen.js exists"
        test -f src/data/telemetryData.js && echo "âœ… telemetryData.js exists"
        echo "âœ… Essential files validated"
        
    - name: ğŸ“ Check for TODO/FIXME comments
      run: |
        echo "Checking for TODO/FIXME comments..."
        grep -r "TODO\|FIXME" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" || echo "No TODO/FIXME comments found"

    - name: ğŸ“² Test telemetry data generation
      run: |
        node -e "
          try {
            const { generateMockTelemetryData } = require('./src/data/telemetryData.js');
            const data = generateMockTelemetryData();
            if (data && data.soc && data.speed) {
              console.log('âœ… Telemetry data generation successful');
            } else {
              throw new Error('Invalid telemetry data structure');
            }
          } catch (error) {
            console.error('âŒ Telemetry data test failed:', error.message);
            process.exit(1);
          }
        "
